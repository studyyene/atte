<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Attendance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-light: #f9f9f9;
      --text-light: #1a1a1a;
      --card-bg-light: #ffffff;
      --bg-dark: #1e1e2f;
      --text-dark: #ffffff;
      --card-bg-dark: #2c2c3e;
    }

    [data-theme="light"] {
      --bg: var(--bg-light);
      --text: var(--text-light);
      --card-bg: var(--card-bg-light);
    }

    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --text: var(--text-dark);
      --card-bg: var(--card-bg-dark);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #4caf50;
      color: white;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 260px;
      transition: background 0.3s;
    }

    .risk {
      color: #ff5252;
      font-weight: bold;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .ring {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 10px auto;
    }

    .ring svg {
      transform: rotate(-90deg);
    }

    .ring circle {
      fill: none;
      stroke-width: 10;
    }

    .ring .bg {
      stroke: #ccc;
    }

    .ring .progress {
      stroke: #4caf50;
      stroke-linecap: round;
    }

    .ring span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: bold;
    }

    canvas {
      background: var(--card-bg);
      border-radius: 12px;
      margin: 30px auto;
      padding: 10px;
      transition: background 0.3s;
      display: block;
      max-width: 800px;
    }

    .summary {
      text-align: center;
      font-size: 20px;
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìò My Attendance Dashboard</h1>
    <div class="controls">
      <button onclick="toggleTheme()">üåó Toggle Theme</button>
      <button onclick="exportPDF()">üì§ Export PDF</button>
    </div>
  </div>
  <div id="container" class="container"></div>
  <div class="summary" id="overall"></div>
  <canvas id="weeklyChart" width="800" height="300"></canvas>
  <canvas id="twoWeekChart" width="800" height="300"></canvas>

  <script>
    const sheetID = "19eSPpF1otsPfAmubvBNXKTLPzrjHeiKiNYnd8JN-GOM";
    const myRegNo = "24BSC712";
    const subjects = [
{ name: "Data Structure", sheet: "DS_T" },
      { name: "DS PRACTICAL", sheet: "DS_P" },
      { name: "Maths", sheet: "SF" },
      { name: "sec", sheet: "SEC" },
      { name: "VAC", sheet: "VAC" },
      { name: "OS", sheet: "OS" },
      { name: "Python", sheet: "Python_T" },
      { name: "Python_practical", sheet: "Python_P" }
    ];

    const container = document.getElementById("container");
    const summary = document.getElementById("overall");
    let overallHeld = 0;
    let overallAttended = 0;
    const weeklyData = {}, twoWeekData = {};

    subjects.forEach(subject => {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(subject.sheet)}`;

      fetch(url)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.trim().split("\n").map(row => row.split(","));
          const myRow = rows.find(r => r[3]?.replace(/"/g, "").trim() === myRegNo);

          if (myRow) {
            const held = parseFloat(myRow[4]?.replace(/"/g, "")) || 0;
            const attended = parseFloat(myRow[5]?.replace(/"/g, "")) || 0;
            const percent = held > 0 ? ((attended / held) * 100).toFixed(1) : 0;
            const risk = percent < 75;

            overallHeld += held;
            overallAttended += attended;

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h3>${subject.name}</h3>
              <div class="ring">
                <svg width="100" height="100">
                  <circle class="bg" cx="50" cy="50" r="45"/>
                  <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="282.6" stroke-dashoffset="${282.6 - (282.6 * percent / 100)}"/>
                </svg>
                <span>${percent}%</span>
              </div>
              <p>${attended} / ${held} Classes</p>
              ${risk ? `<p class="risk">‚ö†Ô∏è At Risk</p>` : ""}
            `;
            container.appendChild(card);

            weeklyData[subject.name] = {
              held: parseFloat(myRow[7]?.replace(/"/g, "")) || 0,
              attended: parseFloat(myRow[8]?.replace(/"/g, "")) || 0
            };

            twoWeekData[subject.name] = [
              parseFloat(myRow[7]?.replace(/"/g, "")) || 0,
              parseFloat(myRow[8]?.replace(/"/g, "")) || 0,
              parseFloat(myRow[9]?.replace(/"/g, "")) || 0,
              parseFloat(myRow[10]?.replace(/"/g, "")) || 0
            ];
          }
        })
        .then(() => {
          if (Object.keys(weeklyData).length === subjects.length) {
            renderChart();
            renderTwoWeekChart();
            const overallPercent = overallHeld > 0 ? ((overallAttended / overallHeld) * 100).toFixed(1) : 0;
            summary.textContent = `üìä Overall Attendance: ${overallAttended} / ${overallHeld} (${overallPercent}%)`;
          }
        });
    });

    function renderChart() {
      const ctx = document.getElementById("weeklyChart").getContext("2d");
      const labels = Object.keys(weeklyData);
      const heldData = labels.map(key => weeklyData[key].held);
      const attendedData = labels.map(key => weeklyData[key].attended);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Week Classes Held', data: heldData, backgroundColor: '#FF9800' },
            { label: 'Week Attended', data: attendedData, backgroundColor: '#4CAF50' }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderTwoWeekChart() {
      const ctx = document.getElementById("twoWeekChart").getContext("2d");
      const labels = Object.keys(twoWeekData);
      const first = labels.map(key => twoWeekData[key][1]);
      const second = labels.map(key => twoWeekData[key][3]);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Week 1 Attendance',
              data: first,
              borderColor: '#03A9F4',
              fill: false
            },
            {
              label: 'Week 2 Attendance',
              data: second,
              borderColor: '#8BC34A',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          tension: 0.3,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function toggleTheme() {
      const html = document.documentElement;
      html.setAttribute("data-theme", html.getAttribute("data-theme") === "dark" ? "light" : "dark");
    }

    function exportPDF() {
      html2canvas(document.body).then(canvas => {
        const img = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        const imgProps = pdf.getImageProperties(img);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(img, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("attendance.pdf");
      });
    }
  </script>
</body>
</html>
